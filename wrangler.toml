# SLC AI Advisor - Cloudflare Worker Configuration
# See: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "slc-ai-advisor"
compatibility_date = "2025-12-01"
compatibility_flags = ["nodejs_compat"]

# Worker entry point (API routes)
main = "./worker/index.ts"

# Enable workers.dev subdomain (required for preview URLs)
workers_dev = true

# Enable preview URLs for non-production branch builds
# See: https://developers.cloudflare.com/workers/configuration/previews/
preview_urls = true

# Static assets configuration (React SPA)
# - directory: where Vite outputs the built frontend
# - not_found_handling: serve index.html for SPA client-side routing
# - run_worker_first: route /api/* and /agents/* to worker before static assets
[assets]
directory = "./dist"
not_found_handling = "single-page-application"
run_worker_first = ["/api/*", "/agents/*"]

# Observability
[observability]
enabled = true

# Vectorize Index for Knowledge Base
# NOTE: Create this index via CLI (see spec/slc-ai-advisor-mvp/design.md):
#   wrangler vectorize create slc-knowledge-base --dimensions 1024 --metric cosine
# Then create metadata indexes for filtering.
# Model: @cf/baai/bge-m3 (1024 dimensions, 60K token context)
[[vectorize]]
binding = "VECTORIZE"
index_name = "slc-knowledge-base"

# KV Namespace for Canvas Registry
# Stores metadata for all canvases (id, name, starred, archived, timestamps)
# Create via: wrangler kv:namespace create "CANVAS_REGISTRY"
[[kv_namespaces]]
binding = "CANVAS_REGISTRY"
id = "placeholder-create-via-wrangler"

# Durable Objects
# - CANVAS: Goal artifact (canvas state with Model Managers)
# - SLC_AGENT: AI conversation orchestrator
[durable_objects]
bindings = [
  { name = "CANVAS", class_name = "CanvasDO" },
  { name = "SLC_AGENT", class_name = "SLCAgent" }
]

# Migration v1: Original UserSession (now deleted)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["UserSession"]

# Migration v2: Two-component architecture (Phase 0)
[[migrations]]
tag = "v2"
new_sqlite_classes = ["CanvasDO", "SLCAgent"]
deleted_classes = ["UserSession"]

# AI Binding for embeddings
[ai]
binding = "AI"

# Analytics Engine for metrics
# Query via: https://developers.cloudflare.com/analytics/analytics-engine/sql-api/
[[analytics_engine_datasets]]
binding = "SLC_ANALYTICS"
dataset = "slc_events"

# Environment Variables (set via wrangler secret or dashboard)
# ANTHROPIC_API_KEY - Set via: wrangler secret put ANTHROPIC_API_KEY
# CF_ACCOUNT_ID - Set via: wrangler secret put CF_ACCOUNT_ID
# CF_GATEWAY_ID - Set via: wrangler secret put CF_GATEWAY_ID

# Development
[dev]
port = 8787
local_protocol = "http"
